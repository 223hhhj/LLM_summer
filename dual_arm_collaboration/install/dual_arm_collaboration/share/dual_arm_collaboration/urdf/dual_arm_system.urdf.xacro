<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="dual_arm_system">

  <!-- 參數定義 -->
  <xacro:arg name="ur5_robot_ip" default="192.168.1.3" />
  <xacro:arg name="arm0710_robot_ip" default="192.168.1.10" />
  <xacro:arg name="use_fake_hardware" default="false" />
  <xacro:arg name="safety_limits" default="true" />
  <xacro:arg name="safety_pos_margin" default="0.15" />
  <xacro:arg name="safety_k_position" default="20" />

  <!-- 材質定義 -->
  <material name="world_material">
    <color rgba="0.2 0.2 0.2 0.1" />
  </material>
  
  <material name="table_material">
    <color rgba="0.8 0.8 0.8 1.0" />
  </material>
  
  <material name="collaboration_material">
    <color rgba="1.0 1.0 0.0 0.3" />
  </material>

  <material name="safety_zone_material">
    <color rgba="1.0 0.0 0.0 0.2" />
  </material>

  <!-- 世界座標系 -->
  <link name="world">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <sphere radius="0.02"/>
      </geometry>
      <material name="world_material" />
    </visual>
    <inertial>
      <mass value="0.001"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
    </inertial>
  </link>

  <!-- 工作台面 -->
  <link name="table">
    <visual>
      <origin xyz="0 0 -0.025" rpy="0 0 0"/>
      <geometry>
        <box size="2.0 2.0 0.05"/>
      </geometry>
      <material name="table_material" />
    </visual>
    <collision>
      <origin xyz="0 0 -0.025" rpy="0 0 0"/>
      <geometry>
        <box size="2.0 2.0 0.05"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 -0.025" rpy="0 0 0"/>
      <mass value="10.0"/>
      <inertia ixx="3.33" ixy="0" ixz="0" iyy="3.33" iyz="0" izz="6.67"/>
    </inertial>
  </link>

  <joint name="world_to_table" type="fixed">
    <parent link="world"/>
    <child link="table"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <!-- UR5 手臂安裝座 -->
  <link name="ur5_mount">
    <visual>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.1" length="0.05"/>
      </geometry>
      <material name="table_material" />
    </visual>
    <collision>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.1" length="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <mass value="2.0"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <joint name="table_to_ur5_mount" type="fixed">
    <origin xyz="0 -0.6 0" rpy="0 0 0"/>
    <parent link="table"/>
    <child link="ur5_mount"/>
  </joint>

  <!-- UR5 手臂基座連接 -->
  <joint name="ur5_base_joint" type="fixed">
    <origin xyz="0 0 0.05" rpy="0 0 0"/>
    <parent link="ur5_mount"/>
    <child link="ur5_base_link"/>
  </joint>

  <!-- 包含 UR5 描述 -->
  <xacro:include filename="$(find ur_description)/urdf/ur.urdf.xacro"/>
  
  <!-- UR5 機器人實例化 -->
  <xacro:ur_robot 
    name="ur5" 
    prefix="ur5_"
    joint_limits_parameters_file="$(find ur_description)/config/ur5/joint_limits.yaml"
    kinematics_parameters_file="$(find ur_description)/config/ur5/default_kinematics.yaml"
    physical_parameters_file="$(find ur_description)/config/ur5/physical_parameters.yaml"
    visual_parameters_file="$(find ur_description)/config/ur5/visual_parameters.yaml"
    safety_limits="$(arg safety_limits)"
    safety_pos_margin="$(arg safety_pos_margin)"
    safety_k_position="$(arg safety_k_position)"
    use_fake_hardware="$(arg use_fake_hardware)"
    fake_sensor_commands="false"
    headless_mode="false"
    robot_ip="$(arg ur5_robot_ip)"
    script_filename="external_control.urscript"
    output_recipe_filename="rtde_output_recipe.txt"
    input_recipe_filename="rtde_input_recipe.txt"
    tf_prefix="ur5_"
    />

  <!-- ARM0710 手臂安裝座 -->
  <link name="arm0710_mount">
    <visual>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.1" length="0.05"/>
      </geometry>
      <material name="table_material" />
    </visual>
    <collision>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.1" length="0.05"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <mass value="2.0"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>

  <joint name="table_to_arm0710_mount" type="fixed">
    <origin xyz="0 0.6 0" rpy="0 0 3.14159"/>
    <parent link="table"/>
    <child link="arm0710_mount"/>
  </joint>

  <!-- ARM0710 手臂基座連接 -->
  <joint name="arm0710_base_joint" type="fixed">
    <origin xyz="0 0 0.05" rpy="0 0 0"/>
    <parent link="arm0710_mount"/>
    <child link="arm0710_base_link"/>
  </joint>

  <!-- 包含 ARM0710 描述 -->
  <xacro:include filename="$(find arm0710_description)/urdf/arm0710.urdf.xacro"/>
  
  <!-- ARM0710 機器人實例化 -->
  <xacro:arm0710_robot prefix="arm0710_"/>

  <!-- 協作區域標記 -->
  <link name="collaboration_zone">
    <visual>
      <origin xyz="0 0 0.01" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.4" length="0.02"/>
      </geometry>
      <material name="collaboration_material" />
    </visual>
    <inertial>
      <origin xyz="0 0 0.01" rpy="0 0 0"/>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>

  <joint name="table_to_collaboration_zone" type="fixed">
    <parent link="table"/>
    <child link="collaboration_zone"/>
    <origin xyz="0 0 0.3" rpy="0 0 0"/>
  </joint>

  <!-- 安全區域標記 -->
  <link name="safety_zone">
    <visual>
      <origin xyz="0 0 0.005" rpy="0 0 0"/>
      <geometry>
        <cylinder radius="0.6" length="0.01"/>
      </geometry>
      <material name="safety_zone_material" />
    </visual>
    <inertial>
      <origin xyz="0 0 0.005" rpy="0 0 0"/>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>

  <joint name="table_to_safety_zone" type="fixed">
    <parent link="table"/>
    <child link="safety_zone"/>
    <origin xyz="0 0 0.2" rpy="0 0 0"/>
  </joint>

  <!-- 工作物件 (示範用) -->
  <link name="work_object">
    <visual>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <box size="0.05 0.05 0.05"/>
      </geometry>
      <material name="work_object_material">
        <color rgba="0.0 1.0 0.0 0.8" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <geometry>
        <box size="0.05 0.05 0.05"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 0.025" rpy="0 0 0"/>
      <mass value="0.1"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
    </inertial>
  </link>

  <joint name="table_to_work_object" type="fixed">
    <parent link="table"/>
    <child link="work_object"/>
    <origin xyz="0.2 0 0" rpy="0 0 0"/>
  </joint>

  <!-- 座標軸標記 -->
  <link name="coordinate_marker">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://ur_description/meshes/ur5/visual/base.dae" scale="0.1 0.1 0.1"/>
      </geometry>
      <material name="coordinate_material">
        <color rgba="1.0 0.0 1.0 0.5" />
      </material>
    </visual>
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.01"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
    </inertial>
  </link>

  <joint name="world_to_coordinate_marker" type="fixed">
    <parent link="world"/>
    <child link="coordinate_marker"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <!-- Gazebo 特定設定 (可選) -->
  <xacro:if value="$(arg use_fake_hardware)">
    <!-- Gazebo 材質設定 -->
    <gazebo reference="table">
      <material>Gazebo/Grey</material>
      <static>true</static>
    </gazebo>
    
    <gazebo reference="collaboration_zone">
      <material>Gazebo/Yellow</material>
      <static>true</static>
    </gazebo>
    
    <gazebo reference="safety_zone">
      <material>Gazebo/Red</material>
      <static>true</static>
    </gazebo>
    
    <gazebo reference="work_object">
      <material>Gazebo/Green</material>
      <static>false</static>
    </gazebo>
  </xacro:if>

</robot>